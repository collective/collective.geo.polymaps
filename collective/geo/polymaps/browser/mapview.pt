<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="iwlearn.project">
<body>
  <metal:content-core fill-slot="content-core">
    <metal:content-core define-macro="content-core">

<div id="cgpolymap" tal:attributes="style view/map_inline_css"> </div>

<script type="text/javascript">
/*<![CDATA[*/

ï»¿/***************************/
//@Author: Adrian "yEnS" Mato Gondelle
//@website: www.yensdesign.com
//@email: yensamg@gmail.com
//@license: Feel free to use it, but keep this credits please!
/***************************/

//SETTING UP OUR POPUP
//0 means disabled; 1 means enabled;
var popupStatus = 0;

//loading popup with jQuery magic!
function loadPopup(){
    //loads popup only if it is disabled
    if(popupStatus==0){
        $("#backgroundPopup").css({
            "opacity": "0.7"
        });
        $("#backgroundPopup").fadeIn("slow");
        $("#popup-map-feature").fadeIn("slow");
        popupStatus = 1;
    }
}

//disabling popup with jQuery magic!
function disablePopup(){
    //disables popup only if it is enabled
    if(popupStatus==1){
        $("#backgroundPopup").fadeOut("slow");
        $("#popup-map-feature").fadeOut("slow");
        popupStatus = 0;
    }
}

//centering popup
function centerPopup(){
    //request data for centering
    var windowWidth = document.documentElement.clientWidth;
    var windowHeight = document.documentElement.clientHeight;
    var popupHeight = $("#popup-map-feature").height();
    var popupWidth = $("#popup-map-feature").width();
    //centering
    $("#popup-map-feature").css({
        "position": "absolute",
        "top": windowHeight/2-popupHeight/2,
        "left": windowWidth/2-popupWidth/2
    });
    //only need force for IE6

    $("#backgroundPopup").css({
        "height": windowHeight
    });

}


function createPopup(e){

    var title = e.childNodes[0].childNodes[0].wholeText;
    var desc = e.childNodes[1].childNodes[0].wholeText;
    var url = e.childNodes[2].childNodes[0].wholeText;
    $('#cgmptitle').html(title);
    $('p#cgmpcontent').html(desc);
    $('a#cgmplink').attr('href', url);
    //centering with css
    centerPopup();
    //load popup
    loadPopup();
}

//CONTROLLING EVENTS IN jQuery
$(document).ready(function(){



    //CLOSING POPUP
    //Click the x event!
    $("#popup-map-featureClose").click(function(){
        disablePopup();
    });
    //Click out event!
    $("#backgroundPopup").click(function(){
        disablePopup();
    });
    //Press Escape event!
    $(document).keypress(function(e){
        if(e.keyCode==27 && popupStatus==1){
            disablePopup();
        }
    });

});


/*]]>*/
</script>

<div id="popup-map-feature" class="overlaybg overlay">
    <div id="popup-map-featureClose" class="close"><span>Close</span></div>
    <div id="cgmpinner">
        <strong id="cgmptitle">Title</strong>

        <p id="cgmpcontent">
            Description
        </p>
        <a id="cgmplink" href="http://iwlearn.net">read more ...</a>
    </div>
</div>

<div id="backgroundPopup"></div>

<script type="text/javascript">
/*<![CDATA[*/
function bounds(features) {
  var i = -1,
      n = features.length,
      geometry,
      bounds = [{lon: Infinity, lat: Infinity}, {lon: -Infinity, lat: -Infinity}];
  while (++i < n) {
    geometry = features[i].data.geometry;
    boundGeometry[geometry.type](bounds, geometry.coordinates);
  }
  return bounds;
}

function boundPoint(bounds, coordinate) {
  var x = coordinate[0], y = coordinate[1];
  if (x < bounds[0].lon) bounds[0].lon = x;
  if (x > bounds[1].lon) bounds[1].lon = x;
  if (y < bounds[0].lat) bounds[0].lat = y;
  if (y > bounds[1].lat) bounds[1].lat = y;
}

function boundPoints(bounds, coordinates) {
  var i = -1, n = coordinates.length;
  while (++i < n) boundPoint(bounds, coordinates[i]);
}

function boundMultiPoints(bounds, coordinates) {
  var i = -1, n = coordinates.length;
  while (++i < n) boundPoints(bounds, coordinates[i]);
}

var boundGeometry = {
  Point: boundPoint,
  MultiPoint: boundPoints,
  LineString: boundPoints,
  MultiLineString: boundMultiPoints,
  Polygon: function(bounds, coordinates) {
    boundPoints(bounds, coordinates[0]); // exterior ring
  },
  MultiPolygon: function(bounds, coordinates) {
    var i = -1, n = coordinates.length;
    while (++i < n) boundPoints(bounds, coordinates[i][0]);
  }
};


function cgpolymap_load(e) {

    Array.max = function( array ){
        return Math.max.apply( Math, array );
    };
    Array.min = function( array ){
        return Math.min.apply( Math, array );
    };

  for (var i = 0; i < e.features.length; i++) {
    var feature = e.features[i];
    feature.element.setAttribute("id", feature.data.id);

   if(feature.data.geometry.type == 'Point') {
            /* set marker image*/
     };

    if (feature.data.geometry.type.indexOf('Polygon') > -1){
        if(feature.data.properties.style.color != null) {
            feature.element.setAttribute("style",
            "fill: #" + feature.data.properties.style.color.substring(0,6) +';' +
            "fill-opacity:" + (parseInt(feature.data.properties.style.color.substring(6,8),16) / 255) +';'
            );
        };
    };

    if (feature.data.geometry.type.indexOf('Line') > -1){
        if(feature.data.properties.style.color != null) {
            feature.element.setAttribute("style",
            "fill: none; fill-opacity: 0.0; " +
            "stroke: #" + feature.data.properties.style.color.substring(0,6) +'; ' +
            "stroke-opacity: " + (parseInt(feature.data.properties.style.color.substring(6,8),16) / 255) +'; ' +
            "stroke-width: " + feature.data.properties.style.width +';'
            );
        };
    };

    feature.element.setAttribute("class", feature.data.properties.classes);

    feature.element.appendChild(po.svg("title").appendChild(
          document.createTextNode(feature.data.properties.title)).parentNode);

    feature.element.appendChild(po.svg("description").appendChild(
          document.createTextNode(feature.data.properties.description)).parentNode);

    feature.element.appendChild(po.svg("link").appendChild(
          document.createTextNode(feature.data.properties.url)).parentNode);
     $(feature.element).click(function( objEvent ){
        createPopup(this);
        }) ;

  };
  map.extent(bounds(e.features)).zoomBy(-.5);
}
/*]]>*/
</script>


<script type="text/javascript" tal:content="view/get_js">
/*<![CDATA[*/

var po = org.polymaps;

var map = po.map()
    .container(document.getElementById("cgpolymap").appendChild(po.svg("svg")))
    .center({lat: 40, lon: -95})
    .zoomRange([3, 7])
    .zoom(4)
    .add(po.interact());

map.add(po.image().url(
          po.url("http://{S}tile.openstreetmap.org" + "/{Z}/{X}/{Y}.png")
          .hosts(["a.","b.","c.",""])));

map.add(po.geoJson()
    .url("http://localhost:8080/Plone/countries/geo-json.json")
    .on("load", cgpolymap_load));

// this must be called after layer creation otherwise it is not visible
map.add(po.compass()
    .pan("none"));

/*]]>*/
</script>

    </metal:content-core>
  </metal:content-core>

</body>
</html>
