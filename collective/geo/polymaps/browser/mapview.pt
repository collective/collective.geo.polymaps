<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="iwlearn.project">
<body>
  <metal:content-core fill-slot="content-core">
    <metal:content-core define-macro="content-core">

<div id="cgpolymap" tal:attributes="style view/map_inline_css"> </div>

<script type="text/javascript">
/*<![CDATA[*/
function bounds(features) {
  var i = -1,
      n = features.length,
      geometry,
      bounds = [{lon: Infinity, lat: Infinity}, {lon: -Infinity, lat: -Infinity}];
  while (++i < n) {
    geometry = features[i].data.geometry;
    boundGeometry[geometry.type](bounds, geometry.coordinates);
  }
  return bounds;
}

function boundPoint(bounds, coordinate) {
  var x = coordinate[0], y = coordinate[1];
  if (x < bounds[0].lon) bounds[0].lon = x;
  if (x > bounds[1].lon) bounds[1].lon = x;
  if (y < bounds[0].lat) bounds[0].lat = y;
  if (y > bounds[1].lat) bounds[1].lat = y;
}

function boundPoints(bounds, coordinates) {
  var i = -1, n = coordinates.length;
  while (++i < n) boundPoint(bounds, coordinates[i]);
}

function boundMultiPoints(bounds, coordinates) {
  var i = -1, n = coordinates.length;
  while (++i < n) boundPoints(bounds, coordinates[i]);
}

var boundGeometry = {
  Point: boundPoint,
  MultiPoint: boundPoints,
  LineString: boundPoints,
  MultiLineString: boundMultiPoints,
  Polygon: function(bounds, coordinates) {
    boundPoints(bounds, coordinates[0]); // exterior ring
  },
  MultiPolygon: function(bounds, coordinates) {
    var i = -1, n = coordinates.length;
    while (++i < n) boundPoints(bounds, coordinates[i][0]);
  }
};


function cgpolymap_load(e) {

    Array.max = function( array ){
        return Math.max.apply( Math, array );
    };
    Array.min = function( array ){
        return Math.min.apply( Math, array );
    };

  for (var i = 0; i < e.features.length; i++) {
    var feature = e.features[i];
    feature.element.setAttribute("id", feature.data.id);

   if(feature.data.geometry.type == 'Point') {
            /* set marker image*/
     };

    if (feature.data.geometry.type.indexOf('Polygon') > -1){
        if(feature.data.properties.style.color != null) {
            feature.element.setAttribute("style",
            "fill: #" + feature.data.properties.style.color.substring(0,6) +';' +
            "fill-opacity:" + (parseInt(feature.data.properties.style.color.substring(6,8),16) / 255) +';'
            );
        };
    };

    if (feature.data.geometry.type.indexOf('Line') > -1){
        if(feature.data.properties.style.color != null) {
            feature.element.setAttribute("style",
            "fill: none; fill-opacity: 0.0; " +
            "stroke: #" + feature.data.properties.style.color.substring(0,6) +'; ' +
            "stroke-opacity: " + (parseInt(feature.data.properties.style.color.substring(6,8),16) / 255) +'; ' +
            "stroke-width: " + feature.data.properties.style.width +';'
            );
        };
    };

    feature.element.setAttribute("class", feature.data.properties.classes);

    feature.element.appendChild(po.svg("title").appendChild(
          document.createTextNode(feature.data.properties.title)).parentNode);

    feature.element.appendChild(po.svg("description").appendChild(
          document.createTextNode(feature.data.properties.description)).parentNode);

    feature.element.appendChild(po.svg("link").appendChild(
          document.createTextNode(feature.data.properties.url)).parentNode)

  };
  map.extent(bounds(e.features)).zoomBy(-.5);
}
/*]]>*/
</script>


<script type="text/javascript" tal:content="view/get_js">
/*<![CDATA[*/

var po = org.polymaps;

var map = po.map()
    .container(document.getElementById("cgpolymap").appendChild(po.svg("svg")))
    .center({lat: 40, lon: -95})
    .zoomRange([3, 7])
    .zoom(4)
    .add(po.interact());

map.add(po.image().url(
          po.url("http://{S}tile.openstreetmap.org" + "/{Z}/{X}/{Y}.png")
          .hosts(["a.","b.","c.",""])));

map.add(po.geoJson()
    .url("http://localhost:8080/Plone/countries/geo-json.json")
    .on("load", cgpolymap_load));

// this must be called after layer creation otherwise it is not visible
map.add(po.compass()
    .pan("none"));

/*]]>*/
</script>

    </metal:content-core>
  </metal:content-core>

</body>
</html>
